# 12 月

## 31

- 创建订单相关逻辑异步
- 修改mbi广州全部门店不显示数据问题
- 核对订单状态
- 修复价格模板门店重复问题

## 30 

- 出餐接口问题调试，美团订单有一单，没有称重单
- 导出重复门店信息

## 27

- 

## 25

- 灰度
- 开发撤单脚本

## 24

- {"type":"19100051309685787830","params":{"orderNo":"19100051309685787830"}}

## 17

- 订单模块优化需求评审
  - 下单支付流程
    - 下单无结果，轮询，弹窗
    - 支付无结果，轮询，弹窗
  - 订单列表
    - 

## 16

- 撤单代码逻辑梳理

## 13

- k8s
  - pod 最小管理单元，存在于工作节点
    - 例如
      - 用户服务有3个实例=3个pod
      - pod = nginx(docker) + php-fpm(docker)
  - service 服务管理
    - 内部dns，内部局域网dns解析，分配虚拟ip给服务
    - 内部服务发现
  - 负载均衡组件
    - 服务内部负载均衡，由服务负载均衡到服务内的每个pod上
  - 管理节点
    - 资源调度
      - 分配cpu和内存给pod
    - 健康检查
    - 镜像生成
    - 部署启动
    - 服务发现
    - 升级运维
    - 缩扩容
  - kind 弹性检测

- 基础服务
  - 3个无状态实例
    - pod=实例
      - nginx
      - php-fpm
    - 
- 容器：无虚拟os
- 减少重复操作：内网dns解析，再容器创建的时候直接解析dns
- 服务监控
- 阿里云ack
- master节点，托管
  - node节点，
  - pod：应用（fpm）
  - service：内网dns
  - 无状态：nginx
  - 有状态：主从
  - 守护进程集（每个节点都有一个守护进程集）：日志收集，
  - 任务：定时任务，定时启动
- agent

- 收银模块+订单模块优化方案
  - 工期：37人天，15天开发周期
  - 数据结构设计 2人天（宋）
  - 创建订单流程接口文档，提供给终端 1人/天 （王）
  - 订单模块新接口，30个接口文档（宋，达） 5天 20号
  1. 服务端，异步优惠券、积分、大礼包、库存、称重单 
       - ssdapi （王）
         - 创建订单接口，生产消息 1人/天
         - 轮询订单状态接口，生产消息 1人/天
       - osp （王）
         - 消费脚本，优惠券，积分，大礼包 1人/天
       - sku（宋）
         - 消费脚本，库存 1人/天
       - stat（宋）
         - 消费脚本，称重单 1人/天
  2. 服务端+客户端，撤单脚本 (达)
       - aos
         - 订单状态添加撤单状态，支付失败
       - order
         - 订单状态添加撤单状态，支付失败 1人/天
       - ssdapi
         - 生产脚本，撤单消息，修改订单状态 1人/天
         - 消费脚本，撤单 2人/天
  3. 服务端，订单状态 
       - aos （达）
         - 消费脚本（终端，官方，三方），双写(保持长时间) 5人/天
         - 创建新表脚本，新订单状态 0.5人/天
       - order （达）
         - 数据表，新增订单状态 0.5人/天
         - 同步缺失订单状态数据，入队列 1人/天
       - 官方外卖 （无工作量）
         - 同步缺失订单状态数据，入队列 0人/天
  4. 服务端+客户端，创建订单流程 （王） 
       - ssdapi
         - 新创建订单接口 2人/天
         - 新订单支付接口 1人/天
         - 新查询订单状态接口，同步查询tps 1人/天
  5. aos全新接口 
       - 订单相关接口（5个接口） 3人/天
  6. order修改接口 
       - 订单相关接口（7个接口） 5人/天
  7. ssdapi
       - 相关新接口（3个+15个） 5人/天

> 消费脚本：无结果，堵塞，消费成功才ack。  
> 三方外卖和官方外卖的订单，只有成功支付的订单。  
> 优惠券消费，可能导致重复消费优惠券。
-----

## 12

- 分支名：create_order

- 方案一 18人天/
  - 12月16号提供原型（产品）
  - 终端UI提供开始3周（2人）
  - 服务端3人3周
  - 联调1周，年前联调完
  - 测试2周，年后测试
  - 总计36个接口（文档），2个数据库表结构，8个消费队列(3个aos)，1个定时脚本
  - aos 服务
    - 修改订单表结构，考虑兼容老数据表
    - 修改aos订单相关接口，根据订单状态修改订单状态，增加缺失订单状态逻辑
      - 10个接口
    - 修改美团队列消费
      - 校对订单状态，无状态处理
    - 修改官方队列消费
      - 校对订单状态，无状态处理
  - order 服务
    - 修改订单表结构，考虑兼容老数据表
    - 修改订单相关接口，根据订单状态修改订单状态，增加缺失订单状态逻辑
      - 10个接口
  - ssd-api 服务
    - 撤单定时脚本，定时撤销支付失败订单
    - 修改终端订单相关接口，根据订单状态修改订单状态，增加缺失订单状态逻辑
      - 16个接口
      - 创建订单接口
      - 支付订单接口
      - 获取支付状态接口
      - 同意退款接口
      - 拒绝退款接口
      - 获取已完成订单列表接口
      - 完成配餐接口
      - 官方订单自配送配送完成接口
      - 拒单接口
      - 接单接口
      - 获取配送详情接口
      - 获取未完成订单接口
      - 获取未完成订单详情接口
      - 新增门店退单接口
      - 获取订单退款状态接口
      - 统计相关接口
    - 优惠券生产异步消息
    - 积分生产异步消息
    - 大礼包生产异步消息
    - 库存生产异步消息
    - 消息称重单生产异步消息
  - osp 服务
    - 优惠券消费异步消息
    - 积分消费异步消息
    - 大礼包消费异步消息
  - sku 服务
    - 库存消费异步消息
  - stat 服务
    - 消息称重单消费异步消息

- 校对订单状态

### 服务端，聚合订单订单状态

| 订单状态 | 退款状态 | 配送状态 | 取消类型 |
| ---- | ---- | ---- | ---- |
| 未支付（D） | 未退款（D） | 门店未接单（待接单）（D） | 未取消（D） |
| 支付中 | 未退款（D） | 门店未接单（待接单）（D） | 未取消（D） |
| 支付成功（F） | 未退款（D）/驳回退款/退款失败 | 门店已接单（已接单）/未配餐/已配餐/待配送/已取餐（配送中）/配送完成 | 未取消（D） |
| 支付失败 | 未退款（D） | 门店未接单（待接单）（D） | 未取消（D） |
| 撤单中 | 未退款（D） | 门店未接单（待接单）（D） | 未取消（D） |
| 撤单成功（F） | 未退款（D） | 门店未接单（待接单）（D） | 系统取消/客户取消/门店取消 |
| 撤单失败 | 未退款（D） | 门店未接单（待接单）（D） | 未取消（D） |
| 退单中 | 申请退款/退款中 | 门店已接单（已接单）/未配餐/已配餐/待配送/已取餐（配送中）/配送完成 | 未取消（D） |
| 退单成功（F） | 退款成功 | 门店已接单（已接单）/未配餐/已配餐/待配送/已取餐（配送中）/配送完成 | 系统取消/客户取消/门店取消 |
| 退单失败 | 驳回退款/退款失败 | 门店已接单（已接单）/未配餐/已配餐/待配送/已取餐（配送中）/配送完成 | 未取消 |

> D：当前状态初始值  
> F：当前状态最终值

### 终端，订单状态

| 订单状态 | 终端 |
| ---- | ---- |
| 未支付（D） | 无 |
| 支付中 | 无 |
| 支付成功（F） | 已支付/已完成（见备注）/待配送/配送中/已送达 |
| 支付失败 | 无 |
| 撤单中 | 无 |
| 撤单成功（F） | 已取消 |
| 撤单失败 | 无 |
| 退单中 | 退款中 |
| 退单成功（F） | 已退单 |
| 退单失败 | 无 |

> 备注：支付成功（F）：删已完成，删未完成，删历史订单。门店订单：支付成功，标记配送完成？

| 配送状态 | 终端 |
| ---- | ---- |
| 门店未接单（待接单）（D） | 已支付 |
| 门店已接单（已接单） | 已支付 |
| 未配餐 | 已支付（备注） |
| 已配餐 | 已支付/已配餐 |
| 待配送 | 待配送 |
| 已取餐（配送中） | 配送中 |
| 配送完成 | 已送达 |

> 备注：未配餐：可以配餐

> D：当前状态初始值  
> F：当前状态最终值

> 问题：

1. 官方外卖，可能出现，审核通过不退钱，终端，显示未退款

 ------
- aos 订单状态
  - 未支付（默认），
  - 支付中
  - 支付成功（最终）
  - 支付失败
  - 撤单中
  - 撤单成功（最终）
  - 撤单失败（支付失败）
  - 退单中
  - 退单成功（最终）
  - 退单失败（支付成功）
- 退款状态
  - 未退款（默认）
  - 申请退款
  - 驳回退款
  - 退款中
  - 退款成功
  - 退款失败
- 配送状态
  - 门店未接单（待接单）（默认）
  - 门店已接单（已接单）
  - 未配餐
  - 已配餐
  - 待配送
  - 已取餐（配送中）
  - 配送完成
- 撤单或退单原因
  - 未退单（默认）
  - 系统退单
  - 客户退单
  - 门店退单
  - 系统撤单
- order 订单状态
  - 未支付
  - 支付中
  - 支付成功
  - 支付失败
  - 撤单中
  - 撤单成功（最终）
  - 撤单失败（最终）
  - 退单中
  - 退单成功（最终）
  - 退单失败（最终）

## 11

- 订单状态
  - 未支付
  - 支付中
  - 支付成功（最终）
  - 支付失败
  - 撤单中
  - 撤单成功（最终）
  - 撤单失败（最终）
  - 退单中
  - 退单成功（最终）
  - 退单失败（最终）
- 退款状态
  - 未退款
  - 申请退款
  - 驳回退款
  - 退款中
  - 退款成功
  - 退款失败
- 配送状态
  - 门店未接单（待接单）
  - 门店已接单（已接单）
  - 未配餐
  - 已配餐（待配送）
  - 已取餐（配送中）
  - 配送完成
- 取消类型
  - 系统取消
  - 客户取消
  - 门店取消

- 方案一 18人天/
  - aos 5
    - 数据结构
    - 队列消费
  - order 2
    - 接口逻辑
  - ssd-api 
    - 撤单，脚本消费 3
    - 创建订单，拆开创建订单和发起支付 3
    - 异步优惠券，积分，大礼包，库存，称重单 2
  - osp
    - 消费 1
  - sku
    - 消费 1
  - stat
    - 消费 1
- 方案二 15人天/
  - aos 5
    - 数据结构
    - 队列消费
  - order 2
    - 接口逻辑
  - ssd-api 
    - 撤单，脚本消费 3
    - 异步优惠券，积分，大礼包，库存，称重单 2
  - osp
    - 消费 1
  - sku
    - 消费 1
  - stat
    - 消费 1

## 10

- 创建订单流程
  - 添加优惠限制，同一个手机号一天只能使用2次优惠，待确认
  - 优惠券消费失败
  - 当前用户的满减，满赠优惠券使用已经到达今天上限
  - 
- 撤销订单
  - 撤销成功和已撤销合并成为撤销成功
  - 

## 5

- 支付流程优化
  - 封装支付code码
- 排查支付宝小程序formid过期问题
  - 特殊key占用40m内存，排查，key没有过期时间
  - 12号以后，修改过期时间，批量删除没有过期时间的key
    - 利用shell脚本，scan处理
- 压力测试
  - 优化内容
    - 订单减库存异步
      - 异常队列，报警没有加
      - 仓库：application-ssd-api 入队列
    - 合并优惠券核销、添加积分、单大礼包，入队列
      - 异常队列，报警没有加
      - 仓库：application-ssd-api 入队列
    - 美团接口异步队列添加-美团完成配餐
      - 异常队列，报警没有加
      - 仓库：application-ssd-api 入队列
    - 美团接口异步队列添加-美团完成配餐
      - 异常队列，报警没有加
      - 仓库：application-tos-api 消费 
      - 消费脚本
    - 合并优惠券核销、添加积分、单大礼包
      - 异常队列，报警没有加
      - 仓库：service-osp-api 消费 
      - 消费脚本
    - 创建订单号，不用上线
      - 仓库：service-ssd-order
    - 订单减库存异步
      - 异常队列，报警没有加
      - 仓库：service-ssd-sku 消费
      - 消费脚本
    - 订单重复检查，不用上线
      - 仓库：service-ssd-stat
  - 分支：stress_testing
  - 注意
    - 生产者，多次生产或者脚本生产，需要重新实例化
    - 消费者，注意数据库超时
  - 上线仓库
    - application-ssd-api 达威
    - application-tos-api 达威
    - service-ssd-sku 孙世豪
    - service-osp-api 王超
  - 压力测试工具
    - 阿里云压力测试工具
  - 先对测试环境进行压力测试
    - 